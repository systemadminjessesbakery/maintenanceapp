<!DOCTYPE html>
<html>
<head>
    <title>Standing Orders</title>
    <!-- Excel Export Library -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script>
        // Convert logo to base64 for PDF export
        const logoImg = document.createElement('img');
        logoImg.src = '/logo';
        logoImg.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = logoImg.width;
            canvas.height = logoImg.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(logoImg, 0, 0);
            window.logoBase64 = canvas.toDataURL('image/jpeg').split(',')[1];
        };
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #4CAF50;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
        }
        .back-button:hover {
            color: #45a049;
        }
        .logo {
            max-width: 100px;
            height: auto;
            margin-bottom: 15px;
        }
        .title-container {
            text-align: center;
        }
        .main-title {
            color: #2c3e50;
            font-size: 28px;
            margin: 0;
            font-weight: bold;
        }
        .subtitle {
            color: #7f8c8d;
            font-size: 16px;
            margin: 5px 0 0 0;
        }
        .container {
            max-width: 95%;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .metrics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .metric-box {
            background-color: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }
        .metric-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }
        .metric-subtitle {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .table-container {
            overflow-x: auto;
            max-height: 80vh;
            position: relative;
        }
        #ordersTable {
            width: 100%;
            margin: 20px auto;
            border-collapse: collapse;
            font-size: 14px;
        }
        #ordersTable thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #ordersTable th {
            background-color: #4CAF50;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 12px;
            text-align: left;
        }
        #ordersTable td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        #ordersTable tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        #ordersTable tr:hover {
            background-color: #ddd;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .button-container {
            text-align: center;
            margin-bottom: 15px;
        }
        .filter-icon {
            margin-left: 5px;
            cursor: pointer;
            font-size: 14px;
            color: white;
        }
        .filter-icon:hover {
            color: rgba(255, 255, 255, 0.8);
        }
        .filter-dropdown {
            position: fixed;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            padding: 10px;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            min-width: 150px;
        }
        .filter-search {
            width: calc(100% - 16px);
            padding: 5px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .filter-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #ddd;
        }
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }
        .editable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .editable:hover {
            background-color: #e9ecef;
        }
        .editing {
            background-color: #fff3cd;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            position: relative;
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .close {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 28px;
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .edit-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .edit-button:hover {
            background-color: #45a049;
        }
        .edit-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #4CAF50;
            border-radius: 4px;
            text-align: right;
        }
        .clear-filters {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        .clear-filters:hover {
            background-color: #f57c00;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-button" onclick="window.location.href='/'">
                <i class="fas fa-arrow-left"></i> Back to Menu
            </button>
            <img src="/logo" alt="Jesse's Bakery Logo" class="logo">
            <div class="title-container">
                <h1 class="main-title">Standing Orders</h1>
                <p class="subtitle">Manage Store Standing Orders</p>
            </div>
        </div>

        <div class="metrics-container">
            <div class="metric-box">
                <div class="metric-title">Total Orders</div>
                <div class="metric-value" id="totalOrders">-</div>
                <div class="metric-subtitle">Active standing orders</div>
            </div>
            <div class="metric-box">
                <div class="metric-title">Total Stores</div>
                <div class="metric-value" id="totalStores">-</div>
                <div class="metric-subtitle">Stores with orders</div>
            </div>
            <div class="metric-box">
                <div class="metric-title">Total Products</div>
                <div class="metric-value" id="totalProducts">-</div>
                <div class="metric-subtitle">Unique products</div>
            </div>
            <div class="metric-box">
                <div class="metric-title">Weekly Total</div>
                <div class="metric-value" id="weeklyTotal">-</div>
                <div class="metric-subtitle">Total weekly orders</div>
            </div>
        </div>

        <div class="button-container">
            <button class="btn" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
            <button class="btn" onclick="addNewOrder()">
                <i class="fas fa-plus"></i> Add New Order
            </button>
            <button class="clear-filters" onclick="clearAllFilters()">
                <i class="fas fa-filter"></i> Clear All Filters
            </button>
            <button class="btn" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Export to Excel
            </button>
            <button class="btn" onclick="exportToPDF()">
                <i class="fas fa-file-pdf"></i> Export to PDF
            </button>
        </div>

        <div id="loading" class="loading">Loading data...</div>
        <div id="status-message" class="status-message"></div>

        <div class="table-container">
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>Store ID <span class="filter-icon" onclick="showFilter('Store_ID', this)">🔍</span></th>
                        <th>Store Name <span class="filter-icon" onclick="showFilter('Store_Name', this)">🔍</span></th>
                        <th>Product ID <span class="filter-icon" onclick="showFilter('Product_ID', this)">🔍</span></th>
                        <th>Product Description <span class="filter-icon" onclick="showFilter('Product_Description', this)">🔍</span></th>
                        <th>SUNDAY</th>
                        <th>MONDAY</th>
                        <th>TUESDAY</th>
                        <th>WEDNESDAY</th>
                        <th>THURSDAY</th>
                        <th>FRIDAY</th>
                        <th>SATURDAY</th>
                        <th>WEEK TOTAL</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Add New Standing Order</h2>
            <form id="orderForm">
                <div class="form-group">
                    <label for="Store_ID">Store</label>
                    <select id="Store_ID" required>
                        <option value="">Select Store</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="Product_ID">Product</label>
                    <select id="Product_ID" required>
                        <option value="">Select Product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="SUNDAY">Sunday</label>
                    <input type="number" id="SUNDAY" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="MONDAY">Monday</label>
                    <input type="number" id="MONDAY" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="TUESDAY">Tuesday</label>
                    <input type="number" id="TUESDAY" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="WEDNESDAY">Wednesday</label>
                    <input type="number" id="WEDNESDAY" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="THURSDAY">Thursday</label>
                    <input type="number" id="THURSDAY" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="FRIDAY">Friday</label>
                    <input type="number" id="FRIDAY" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="SATURDAY">Saturday</label>
                    <input type="number" id="SATURDAY" min="0" value="0">
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let orders = [];
        let stores = [];
        let products = [];
        let activeFilters = {};

        async function fetchData() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                // Fetch both standing orders and products data
                const [ordersResponse, productsResponse] = await Promise.all([
                    fetch('/api/standing-orders'),
                    fetch('/api/products')
                ]);

                if (!ordersResponse.ok || !productsResponse.ok) {
                    throw new Error('Failed to fetch data');
                }

                const ordersData = await ordersResponse.json();
                const productsData = await productsResponse.json();

                // Ensure we have valid data
                if (!ordersData) {
                    throw new Error('No orders data received from server');
                }

                // Extract orders, stores, and products from the responses
                if (Array.isArray(ordersData)) {
                    orders = ordersData;
                } else if (ordersData.standingOrders) {
                    orders = ordersData.standingOrders;
                    stores = ordersData.stores || [];
                } else if (ordersData.orders) {
                    orders = ordersData.orders;
                    stores = ordersData.stores || [];
                } else {
                    throw new Error('Invalid orders data format');
                }

                // Handle products data
                if (Array.isArray(productsData)) {
                    products = productsData;
                } else if (productsData.products) {
                    products = productsData.products;
                } else {
                    throw new Error('Invalid products data format');
                }

                // Map product descriptions to orders
                orders = orders.map(order => {
                    const product = products.find(p => String(p.Product_ID) === String(order.Product_ID));
                    return {
                        ...order,
                        Product_Description: product ? product.Product_Description : 'Unknown Product'
                    };
                });

                // Calculate week totals
                orders = orders.map(order => {
                    const weekTotal = ['SUNDAY', 'MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY']
                        .reduce((sum, day) => sum + (parseInt(order[day]) || 0), 0);
                    return {
                        ...order,
                        'Week_Total': weekTotal
                    };
                });

                // Update the UI
                updateMetrics(orders);
                populateTable(orders);
                updateStoreSelect();
                updateProductSelect();

                loading.style.display = 'none';
                showStatusMessage('Data loaded successfully', true);
            } catch (error) {
                console.error('Error fetching data:', error);
                loading.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
                showStatusMessage('Error loading data: ' + error.message, false);
            }
        }

        function updateMetrics(data) {
            if (!Array.isArray(data)) {
                console.error('Invalid data format for metrics update');
                return;
            }

            // Count total orders
            document.getElementById('totalOrders').textContent = data.length;

            // Count unique stores
            const uniqueStores = new Set(data.map(item => item.Store_ID)).size;
            document.getElementById('totalStores').textContent = uniqueStores;

            // Count unique products
            const uniqueProducts = new Set(data.map(item => item.Product_ID)).size;
            document.getElementById('totalProducts').textContent = uniqueProducts;

            // Calculate weekly total
            const weeklyTotal = data.reduce((sum, item) => sum + (parseInt(item.Week_Total) || 0), 0);
            document.getElementById('weeklyTotal').textContent = weeklyTotal.toLocaleString();

            // Update subtitles if filtered
            const hasFilters = Object.keys(activeFilters).length > 0;
            const filterInfo = hasFilters ? ' (Filtered)' : '';
            document.querySelectorAll('.metric-subtitle').forEach(subtitle => {
                subtitle.textContent = subtitle.textContent.split('(')[0] + filterInfo;
            });
        }

        function populateTable(data) {
            if (!Array.isArray(data)) {
                console.error('Invalid data format for table population');
                return;
            }

            const tbody = document.querySelector('#ordersTable tbody');
            tbody.innerHTML = '';
            
            data.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.Store_ID}</td>
                    <td>${order.Store_Name}</td>
                    <td>${order.Product_ID}</td>
                    <td>${order.Product_Description}</td>
                    <td class="editable" data-id="${order.Order_ID}" data-field="SUNDAY">${order.SUNDAY || 0}</td>
                    <td class="editable" data-id="${order.Order_ID}" data-field="MONDAY">${order.MONDAY || 0}</td>
                    <td class="editable" data-id="${order.Order_ID}" data-field="TUESDAY">${order.TUESDAY || 0}</td>
                    <td class="editable" data-id="${order.Order_ID}" data-field="WEDNESDAY">${order.WEDNESDAY || 0}</td>
                    <td class="editable" data-id="${order.Order_ID}" data-field="THURSDAY">${order.THURSDAY || 0}</td>
                    <td class="editable" data-id="${order.Order_ID}" data-field="FRIDAY">${order.FRIDAY || 0}</td>
                    <td class="editable" data-id="${order.Order_ID}" data-field="SATURDAY">${order.SATURDAY || 0}</td>
                    <td>${order.Week_Total || 0}</td>
                    <td>
                        <button class="edit-button" onclick="toggleEditMode(this)">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;

                // Add click handlers for editable cells
                const editableCells = row.querySelectorAll('.editable');
                editableCells.forEach(cell => {
                    cell.addEventListener('click', function() {
                        if (!this.parentElement.classList.contains('edit-mode')) return;
                        if (this.querySelector('input')) return;
                        
                        const id = this.dataset.id;
                        const field = this.dataset.field;
                        const currentValue = this.textContent;
                        
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.min = '0';
                        input.value = currentValue;
                        input.className = 'edit-input';
                        
                        input.addEventListener('blur', async function() {
                            const newValue = parseInt(this.value) || 0;
                            if (newValue !== parseInt(currentValue)) {
                                try {
                                    const order = orders.find(o => o.Order_ID === parseInt(id));
                                    if (!order) throw new Error('Order not found');
                                    
                                    order[field] = newValue;
                                    
                                    // Update week total
                                    order.Week_Total = ['SUNDAY', 'MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY']
                                        .reduce((sum, day) => sum + (parseInt(order[day]) || 0), 0);
                                    
                                    const response = await fetch('/api/standing-orders/update', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify(order)
                                    });

                                    if (!response.ok) {
                                        throw new Error('Failed to update order');
                                    }

                                    this.parentElement.textContent = newValue.toLocaleString();
                                    const weekTotalCell = this.parentElement.parentElement.querySelector('td:nth-last-child(2)');
                                    weekTotalCell.textContent = order.Week_Total.toLocaleString();
                                    updateMetrics(orders);
                                    showStatusMessage('Order updated successfully', true);
                                } catch (error) {
                                    console.error('Error updating order:', error);
                                    this.parentElement.textContent = currentValue;
                                    showStatusMessage('Error updating order: ' + error.message, false);
                                }
                            } else {
                                this.parentElement.textContent = currentValue;
                            }
                        });

                        input.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter') {
                                this.blur();
                            }
                        });

                        this.textContent = '';
                        this.appendChild(input);
                        input.focus();
                        input.select();
                    });
                });

                tbody.appendChild(row);
            });
        }

        function toggleEditMode(button) {
            const row = button.closest('tr');
            const isEditMode = row.classList.contains('edit-mode');
            
            // Remove edit mode from all rows
            document.querySelectorAll('tr.edit-mode').forEach(r => {
                r.classList.remove('edit-mode');
                r.querySelectorAll('.editable').forEach(cell => {
                    cell.classList.remove('editing');
                });
            });
            
            // Toggle edit mode for the clicked row
            if (!isEditMode) {
                row.classList.add('edit-mode');
                row.querySelectorAll('.editable').forEach(cell => {
                    cell.classList.add('editing');
                });
                button.innerHTML = '<i class="fas fa-check"></i>';
            } else {
                row.classList.remove('edit-mode');
                row.querySelectorAll('.editable').forEach(cell => {
                    cell.classList.remove('editing');
                });
                button.innerHTML = '<i class="fas fa-edit"></i>';
            }
        }

        function updateStoreSelect() {
            const select = document.getElementById('Store_ID');
            if (!select) return;

            select.innerHTML = '<option value="">Select Store</option>';
            if (!Array.isArray(stores)) return;

            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store.Store_ID;
                option.textContent = `${store.Store_ID} - ${store.Store_Name}`;
                select.appendChild(option);
            });
        }

        function updateProductSelect() {
            const select = document.getElementById('Product_ID');
            if (!select) return;

            select.innerHTML = '<option value="">Select Product</option>';
            if (!Array.isArray(products)) return;

            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.Product_ID;
                option.textContent = `${product.Product_ID} - ${product.Product_Description}`;
                select.appendChild(option);
            });
        }

        function showFilter(column, element) {
            const existingDropdowns = document.querySelectorAll('.filter-dropdown');
            existingDropdowns.forEach(dropdown => dropdown.remove());

            const values = [...new Set(orders.map(row => row[column]))].filter(value => value !== null && value !== '');
            
            const dropdown = document.createElement('div');
            dropdown.className = 'filter-dropdown';
            
            const search = document.createElement('input');
            search.type = 'text';
            search.className = 'filter-search';
            search.placeholder = 'Search...';
            search.oninput = (e) => {
                const searchText = e.target.value.toLowerCase();
                dropdown.querySelectorAll('label').forEach(label => {
                    const text = label.textContent.toLowerCase();
                    label.style.display = text.includes(searchText) ? '' : 'none';
                });
            };
            dropdown.appendChild(search);

            values.sort().forEach(value => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = activeFilters[column]?.includes(value) || false;
                checkbox.value = value;
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(value));
                dropdown.appendChild(label);
            });

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'filter-buttons';
            
            const applyButton = document.createElement('button');
            applyButton.textContent = 'Apply';
            applyButton.onclick = () => applyFilter(column, dropdown);
            
            const clearButton = document.createElement('button');
            clearButton.textContent = 'Clear';
            clearButton.onclick = () => clearFilter(column);
            
            buttonContainer.appendChild(clearButton);
            buttonContainer.appendChild(applyButton);
            dropdown.appendChild(buttonContainer);

            const rect = element.getBoundingClientRect();
            dropdown.style.top = `${rect.bottom + window.scrollY}px`;
            dropdown.style.left = `${rect.left}px`;
            document.body.appendChild(dropdown);

            document.addEventListener('click', function closeDropdown(e) {
                if (!dropdown.contains(e.target) && e.target !== element) {
                    dropdown.remove();
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        function applyFilter(column, dropdown) {
            const selectedValues = Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedValues.length > 0) {
                activeFilters[column] = selectedValues;
            } else {
                delete activeFilters[column];
            }

            let filteredData = orders;
            Object.entries(activeFilters).forEach(([col, values]) => {
                filteredData = filteredData.filter(row => values.includes(row[col].toString()));
            });

            updateMetrics(filteredData);
            populateTable(filteredData);
            dropdown.remove();
            showStatusMessage('Filter applied', true);
        }

        function clearFilter(column) {
            delete activeFilters[column];
            const filteredData = applyAllFilters();
            updateMetrics(filteredData);
            populateTable(filteredData);
            const dropdown = document.querySelector('.filter-dropdown');
            if (dropdown) dropdown.remove();
            showStatusMessage('Filter cleared', true);
        }

        function clearAllFilters() {
            activeFilters = {};
            updateMetrics(orders);
            populateTable(orders);
            showStatusMessage('All filters cleared', true);
        }

        function applyAllFilters() {
            let filteredData = orders;
            Object.entries(activeFilters).forEach(([column, values]) => {
                filteredData = filteredData.filter(row => values.includes(row[column].toString()));
            });
            return filteredData;
        }

        function showStatusMessage(message, isSuccess) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + (isSuccess ? 'status-success' : 'status-error');
            statusDiv.style.display = 'block';
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        function showAddModal() {
            const modal = document.getElementById('orderModal');
            const form = document.getElementById('orderForm');
            const title = document.getElementById('modalTitle');
            
            title.textContent = 'Add New Standing Order';
            form.reset();
            updateStoreSelect();
            updateProductSelect();
            modal.style.display = 'block';
        }

        function closeModal() {
            const modal = document.getElementById('orderModal');
            modal.style.display = 'none';
        }

        document.getElementById('orderForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const formData = {
                Store_ID: document.getElementById('Store_ID').value,
                Product_ID: document.getElementById('Product_ID').value,
                Store_Name: stores.find(s => s.Store_ID === document.getElementById('Store_ID').value)?.Store_Name || '',
                Product_Name: products.find(p => p.Product_ID === document.getElementById('Product_ID').value)?.Product_Name || '',
                SUNDAY: parseInt(document.getElementById('SUNDAY').value) || 0,
                MONDAY: parseInt(document.getElementById('MONDAY').value) || 0,
                TUESDAY: parseInt(document.getElementById('TUESDAY').value) || 0,
                WEDNESDAY: parseInt(document.getElementById('WEDNESDAY').value) || 0,
                THURSDAY: parseInt(document.getElementById('THURSDAY').value) || 0,
                FRIDAY: parseInt(document.getElementById('FRIDAY').value) || 0,
                SATURDAY: parseInt(document.getElementById('SATURDAY').value) || 0,
                'WEEK TOTAL': parseInt(document.getElementById('SUNDAY').value) || 0 +
                            parseInt(document.getElementById('MONDAY').value) || 0 +
                            parseInt(document.getElementById('TUESDAY').value) || 0 +
                            parseInt(document.getElementById('WEDNESDAY').value) || 0 +
                            parseInt(document.getElementById('THURSDAY').value) || 0 +
                            parseInt(document.getElementById('FRIDAY').value) || 0 +
                            parseInt(document.getElementById('SATURDAY').value) || 0
            };

            try {
                const response = await fetch('/api/standing-orders/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error('Failed to add order');
                }

                showStatusMessage('Order added successfully', true);
                closeModal();
                fetchData();
            } catch (error) {
                console.error('Error adding order:', error);
                showStatusMessage('Error adding order: ' + error.message, false);
            }
        };

        function exportToExcel() {
            const data = applyAllFilters();
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Standing Orders');
            
            // Set column widths
            const columnWidths = [
                {wch: 8},  // Store_ID
                {wch: 10}, // Product_ID
                {wch: 30}, // Store_Name
                {wch: 30}, // Product_Name
                {wch: 8},  // SUNDAY
                {wch: 8},  // MONDAY
                {wch: 8},  // TUESDAY
                {wch: 8},  // WEDNESDAY
                {wch: 8},  // THURSDAY
                {wch: 8},  // FRIDAY
                {wch: 8},  // SATURDAY
                {wch: 10}, // WEEK TOTAL
                {wch: 18}  // Date Created
            ];
            worksheet['!cols'] = columnWidths;

            const filename = `JessesBakery_StandingOrders_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, filename);
            showStatusMessage('Excel file exported successfully', true);
        }

        function exportToPDF() {
            const data = applyAllFilters();
            
            const docDefinition = {
                pageOrientation: 'landscape',
                pageSize: 'A4',
                pageMargins: [20, 40, 20, 40],
                header: {
                    columns: [
                        {
                            image: 'data:image/jpeg;base64,' + logoBase64,
                            width: 30,
                            margin: [20, 10, 0, 0]
                        },
                        {
                            text: 'Jesse\'s Bakery - Standing Orders',
                            alignment: 'right',
                            margin: [0, 15, 20, 0],
                            fontSize: 10
                        }
                    ]
                },
                content: [
                    {
                        table: {
                            headerRows: 1,
                            widths: ['auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto'],
                            body: [
                                // Header
                                Object.keys(data[0]).map(key => ({
                                    text: key,
                                    style: 'tableHeader'
                                })),
                                // Data
                                ...data.map(row => 
                                    Object.values(row).map(value => ({
                                        text: value,
                                        style: 'tableCell'
                                    }))
                                )
                            ]
                        },
                        layout: {
                            fillColor: function(rowIndex) {
                                return (rowIndex === 0) ? '#4CAF50' : (rowIndex % 2 === 0) ? '#f2f2f2' : null;
                            }
                        }
                    }
                ],
                styles: {
                    tableHeader: {
                        bold: true,
                        fontSize: 8,
                        color: 'white',
                        fillColor: '#4CAF50',
                        alignment: 'left',
                        margin: [2, 4]
                    },
                    tableCell: {
                        fontSize: 8,
                        margin: [2, 4]
                    }
                },
                footer: function(currentPage, pageCount) {
                    return {
                        text: `Page ${currentPage} of ${pageCount}`,
                        alignment: 'center',
                        fontSize: 8,
                        margin: [0, 10]
                    };
                }
            };

            const filename = `JessesBakery_StandingOrders_${new Date().toISOString().split('T')[0]}.pdf`;
            pdfMake.createPdf(docDefinition).download(filename);
            showStatusMessage('PDF file exported successfully', true);
        }

        // Initialize the page
        window.onload = fetchData;
    </script>
</body>
</html> 